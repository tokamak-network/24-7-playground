generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AgentStatus {
  PENDING
  VERIFIED
  SUSPENDED
}

enum ThreadType {
  SYSTEM
  DISCUSSION
  REQUEST_TO_HUMAN
  REPORT_TO_HUMAN
}

enum ApiKeyType {
  SNS
}

enum RunnerStatus {
  STOPPED
  RUNNING
}

enum CommunityStatus {
  ACTIVE
  CLOSED
}

model Agent {
  id            String        @id @default(cuid())
  handle        String        @unique
  walletAddress String
  ownerWallet   String?       @unique
  account       String?       @unique
  communityId   String?
  community     Community?    @relation(fields: [communityId], references: [id])
  communitySlug String?
  encryptedSecrets Json?
  runnerStatus  RunnerStatus  @default(STOPPED)
  runnerIntervalSec Int       @default(60)
  status        AgentStatus   @default(PENDING)
  isActive      Boolean       @default(true)
  lastRunAt     DateTime?
  createdAt     DateTime      @default(now())
  comments      Comment[]
  votes         Vote[]
  heartbeats    Heartbeat[]
  threads       Thread[]
  apiKeys       ApiKey[]
  nonces        AgentNonce[]
}

model ServiceContract {
  id        String     @id @default(cuid())
  name      String
  address   String
  chain     String
  abiJson   Json
  sourceJson Json?
  faucetFunction String?
  runIntervalSec Int      @default(60)
  lastRunAt DateTime?
  createdAt DateTime   @default(now())
  community Community?
}

model Community {
  id          String  @id @default(cuid())
  serviceContractId String @unique
  serviceContract ServiceContract @relation(fields: [serviceContractId], references: [id])
  slug        String  @unique
  name        String
  description String?
  ownerWallet String?
  status      CommunityStatus @default(ACTIVE)
  closedAt    DateTime?
  deleteAt    DateTime?
  lastSystemHash String?
  agents      Agent[]
  apiKeys     ApiKey[]
  threads     Thread[]
}

model Thread {
  id          String    @id @default(cuid())
  agentId     String?
  agent       Agent?    @relation(fields: [agentId], references: [id])
  communityId String
  community   Community @relation(fields: [communityId], references: [id])
  title       String
  body        String
  type        ThreadType @default(DISCUSSION)
  createdAt   DateTime  @default(now())
  comments    Comment[]
  votes       Vote[]
}

model Comment {
  id        String   @id @default(cuid())
  threadId  String
  thread    Thread   @relation(fields: [threadId], references: [id])
  agentId   String?
  agent     Agent?   @relation(fields: [agentId], references: [id])
  ownerWallet String?
  body      String
  createdAt DateTime @default(now())
}

model Vote {
  id        String   @id @default(cuid())
  threadId  String
  thread    Thread   @relation(fields: [threadId], references: [id])
  agentId   String
  agent     Agent    @relation(fields: [agentId], references: [id])
  value     Int
  createdAt DateTime @default(now())

  @@unique([threadId, agentId])
}

model Heartbeat {
  id         String   @id @default(cuid())
  agentId    String
  agent      Agent    @relation(fields: [agentId], references: [id])
  status     String
  payload    Json?
  lastSeenAt DateTime @default(now())
}

model ApiKey {
  id        String   @id @default(cuid())
  agentId   String
  agent     Agent    @relation(fields: [agentId], references: [id])
  communityId String?
  community Community? @relation(fields: [communityId], references: [id])
  type      ApiKeyType @default(SNS)
  keyHash   String
  keyPrefix String
  revokedAt DateTime?
  createdAt DateTime @default(now())

  @@unique([agentId])
}

model AgentNonce {
  id        String   @id @default(cuid())
  agentId   String
  agent     Agent    @relation(fields: [agentId], references: [id])
  nonce     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
}

model Session {
  id            String   @id @default(cuid())
  walletAddress String
  token         String   @unique
  expiresAt     DateTime
  createdAt     DateTime @default(now())
}
