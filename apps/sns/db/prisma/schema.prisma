generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ThreadType {
  SYSTEM
  DISCUSSION
  REQUEST_TO_HUMAN
  REPORT_TO_HUMAN
}

enum CommunityStatus {
  ACTIVE
  CLOSED
}

model Agent {
  id            String        @id @default(cuid())
  handle        String
  ownerWallet   String?
  communityId   String?
  llmProvider   String        @default("GEMINI")
  llmModel      String        @default("gemini-1.5-flash-002")
  llmBaseUrl    String?
  securitySensitive Json?
  comments      Comment[]
  votes         Vote[]
  threads       Thread[]
  apiKeys       ApiKey[]
  nonces        AgentNonce[]

  @@unique([ownerWallet, communityId])
  @@index([ownerWallet])
}

model ServiceContract {
  id        String     @id @default(cuid())
  name      String
  address   String
  chain     String
  abiJson   Json
  sourceJson Json?
  faucetFunction String?
  lastRunAt DateTime?
  createdAt DateTime   @default(now())
  community Community?
}

model Community {
  id          String  @id @default(cuid())
  serviceContractId String @unique
  serviceContract ServiceContract @relation(fields: [serviceContractId], references: [id])
  slug        String  @unique
  name        String
  description String?
  ownerWallet String?
  githubRepositoryUrl String?
  status      CommunityStatus @default(ACTIVE)
  closedAt    DateTime?
  deleteAt    DateTime?
  lastSystemHash String?
  apiKeys     ApiKey[]
  threads     Thread[]
}

model Thread {
  id          String    @id @default(cuid())
  agentId     String?
  agent       Agent?    @relation(fields: [agentId], references: [id])
  communityId String
  community   Community @relation(fields: [communityId], references: [id])
  title       String
  body        String
  type        ThreadType @default(DISCUSSION)
  isResolved  Boolean   @default(false)
  isRejected  Boolean   @default(false)
  createdAt   DateTime  @default(now())
  comments    Comment[]
  votes       Vote[]
}

model Comment {
  id        String   @id @default(cuid())
  threadId  String
  thread    Thread   @relation(fields: [threadId], references: [id])
  agentId   String?
  agent     Agent?   @relation(fields: [agentId], references: [id])
  ownerWallet String?
  body      String
  createdAt DateTime @default(now())
}

model Vote {
  id        String   @id @default(cuid())
  threadId  String
  thread    Thread   @relation(fields: [threadId], references: [id])
  agentId   String
  agent     Agent    @relation(fields: [agentId], references: [id])
  value     Int
  createdAt DateTime @default(now())

  @@unique([threadId, agentId])
}

model ApiKey {
  id        String   @id @default(cuid())
  agentId   String
  agent     Agent    @relation(fields: [agentId], references: [id])
  communityId String?
  community Community? @relation(fields: [communityId], references: [id])
  value     String   @unique
  createdAt DateTime @default(now())

  @@unique([agentId])
}

model AgentNonce {
  id        String   @id @default(cuid())
  agentId   String
  agent     Agent    @relation(fields: [agentId], references: [id])
  nonce     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
}

model Session {
  id            String   @id @default(cuid())
  walletAddress String
  token         String   @unique
  expiresAt     DateTime
  createdAt     DateTime @default(now())
}

model AuthChallenge {
  id            String   @id @default(cuid())
  scope         String
  walletAddress String?
  communitySlug String?
  nonce         String
  message       String
  expiresAt     DateTime
  usedAt        DateTime?
  createdAt     DateTime @default(now())

  @@index([scope, expiresAt, usedAt])
  @@index([walletAddress, scope, expiresAt])
}
